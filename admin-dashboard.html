<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/519836b792.js" crossorigin="anonymous"></script>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="js/config.js"></script>
    <script src="popup-loader.js"></script>
</head>
<!-- <body style="background: url('background.jpg') no-repeat center center fixed; background-size: cover;"> -->

    <!-- Sidebar -->
    <div class="sidebar">
        <h3 class="text-center text-white mt-3">Admin Panel</h3>
        <ul>
            <li><a href="#" onclick="showSection('dashboard')">Dashboard</a></li>
            <li><a href="#" onclick="showSection('manageBookings')">Manage Bookings</a></li>
            <li><a href="#" onclick="showSection('trackTicket')">Track Ticket</a></li>
            <li><a href="#" onclick="showSection('exportReports')">Export Reports</a></li> <!-- Added Export Reports Link -->
            <li><a href="#" onclick="showSection('send-notification')">Sent Notifications</a></li> <!-- Added Export Reports Link -->
            <li><a href="#" onclick="goHome()">Home</a></li>
            <li><a href="#" onclick="handleAdminLogout()">Logout</a></li>
        </ul>               
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header mb-4">
            <h1 class="mb-0"><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
            <p class="text-muted">Manage bookings, track tickets, and send notifications</p>
        </div>

        <!-- Dashboard Overview -->
        <div id="dashboard" class="section">

            <div class="dashboard-grid">
                <div class="box">
                    <p><i class="fas fa-ticket-alt"></i> Total Bookings</p>
                    <span id="totalBookings">0</span>
                </div>
                <div class="box">
                    <p><i class="fas fa-clock"></i> Pending Approvals</p>
                    <span id="pendingBookings">0</span>
                </div>
                <div class="box">
                    <p><i class="fas fa-times-circle"></i> Cancelled Tickets</p>
                    <span id="cancelledBookings">0</span>
                </div>
                <div class="box">
                    <p><i class="fas fa-calendar-day"></i> Today's Bookings</p>
                    <span id="todaysBookings">0</span>
                </div>
            </div>
        </div>

        <!-- Manage Bookings -->
        <div id="manageBookings" class="section" style="display:none;">
            <h2 class="text-black"><i class="fas fa-list-alt"></i> Manage Bookings</h2>
            <input type="text" id="searchBooking" placeholder="Search by Ticket ID, Name, Mobile..." class="form-control mb-3" oninput="filterBookings()">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Ticket ID</th>
                        <th>Name</th>
                        <th>Temple</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="bookingList">
                    <tr><td colspan="7">Loading...</td></tr>
                </tbody>
            </table>

            <button class="btn btn-danger" onclick="clearAllBookings()"><i class="fas fa-trash-alt"></i> Clear All Bookings</button>
        </div>

        <!-- Track Ticket -->
        <div id="trackTicket" class="section" style="display:none;">
            <h2 class="text-dark"><i class="fas fa-search"></i> Track Ticket</h2>
            <input type="text" id="trackTicketId" placeholder="Enter Ticket ID" class="form-control mb-3">
            <button class="btn btn-modern" onclick="trackTicket()">Track</button>
            <div id="ticketDetails" class="mt-3">
                <!-- Ticket details will appear here -->
            </div>
        </div>

        <!-- Export Reports Section -->
        <div id="exportReports" class="section" style="display:none;">
            <h2 class="text-black"><i class="fas fa-file-export"></i> Export Reports</h2>
            
            <!-- Filter Options -->
            <div class="export-filters">
                <label for="filterStatus">Status:</label>
                <select id="filterStatus" class="form-select">
                    <option value="">All</option>
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Cancelled">Cancelled</option>
                </select>

                <label for="filterStartDate">Start Date:</label>
                <input type="date" id="filterStartDate" class="form-control">

                <label for="filterEndDate">End Date:</label>
                <input type="date" id="filterEndDate" class="form-control">
            </div>

            <!-- Export Buttons -->
            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportBookings('csv')"><i class="fas fa-download"></i> Export as CSV</button>
                <button class="btn btn-success" onclick="exportBookings('excel')"><i class="fas fa-file-excel"></i> Export as Excel</button>
                <button class="btn btn-danger" onclick="exportBookings('pdf')"><i class="fas fa-file-pdf"></i> Export as PDF</button>
            </div>
        </div>

        <!-- Send Notifications Section -->
        <div id="send-notification" class="section" style="display: none;">
            <div class="send-notification-section p-4 bg-light rounded text-dark">
            <h4 class="mb-3"><i class="fas fa-bullhorn"></i> Send Notification</h4>
        
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="broadcastToggle" onchange="toggleBroadcastMode()" />
                <label class="form-check-label" for="broadcastToggle">Broadcast to all users</label>
            </div>
        
            <!-- Only show email field when broadcast is OFF -->
            <div id="userEmailField" class="mb-2">
                <input type="email" id="notifyEmail" class="form-control" placeholder="Enter user's email" />
            </div>
        
            <input type="text" id="notifyMessage" class="form-control mb-2" placeholder="Notification message" />
        
            <select id="notifyType" class="form-select mb-3">
                <option value="info">‚ÑπÔ∏è Info</option>
                <option value="success">‚úÖ Success</option>
                <option value="warning">‚ö†Ô∏è Warning</option>
                <option value="error">‚ùå Error</option>
            </select>
        
            <button class="btn btn-primary w-100" onclick="sendNotification()">Send Notification</button>
            </div>
        </div>
</div>


    <script>
        const adminUser = JSON.parse(localStorage.getItem("adminUser"));
        if (!adminUser) {
            // Prevent entire admin page rendering and wait for login
            document.addEventListener("DOMContentLoaded", () => {
            document.body.innerHTML = ""; // Clear page
            const link = document.createElement("link");
            link.rel = "stylesheet";
            link.href = "login-popup.css"; // Optional: your modal style
            document.head.appendChild(link);

            fetch("login-popup.html") // Or whatever path your popup HTML is
                .then(res => res.text())
                .then(html => {
                document.body.innerHTML = html;
                window.loginPopupLoaded = true;
                showLoginPopup("admin");
                })
                .catch(err => {
                alert("Failed to load login popup.");
                console.error(err);
                });
            });
        }

        // ‚úÖ Show Dashboard Section
        function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';
        document.querySelectorAll(".sidebar ul li a").forEach(link => link.classList.remove("active"));
        let activeLink = document.querySelector(`.sidebar ul li a[onclick="showSection('${sectionId}')"]`);
        if (activeLink) activeLink.classList.add("active");
        }

        // ‚úÖ DOMContentLoaded Initializer
        window.addEventListener("DOMContentLoaded", () => {
        fetchDashboardStats();
        fetchBookings();

        const sidebarLinks = document.querySelectorAll(".sidebar ul li a");
        sidebarLinks.forEach(link => {
            link.addEventListener("click", e => {
            e.preventDefault();
            const sectionId = link.getAttribute("data-section");
            if (sectionId) showSection(sectionId);
            });
        });

        if (sidebarLinks.length > 0) sidebarLinks[0].click();
        });

        // ‚úÖ Fetch Dashboard Stats
        async function fetchDashboardStats() {
        try {
            const res = await fetch(`${AppConfig.API_BASE_URL}/admin/stats`);
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            // ‚úÖ Check if elements exist before accessing them
            const totalBookings = document.getElementById("totalBookings");
            const pendingBookings = document.getElementById("pendingBookings");
            const cancelledBookings = document.getElementById("cancelledBookings");
            const todaysBookings = document.getElementById("todaysBookings");

            if (totalBookings) totalBookings.innerText = data.totalBookings;
            if (pendingBookings) pendingBookings.innerText = data.pendingBookings;
            if (cancelledBookings) cancelledBookings.innerText = data.cancelledBookings;
            if (todaysBookings) todaysBookings.innerText = data.todaysBookings;
        } catch (err) {
            console.error("\u274C Error fetching dashboard stats:", err);
        }
        }

        // ‚úÖ Fetch All Bookings
        async function fetchBookings(searchText = "") {
        try {
            const res = await fetch(`${AppConfig.API_BASE_URL}/api/bookings?search=${searchText}`);
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            const bookingList = document.getElementById("bookingList");
            if (!bookingList) {
                console.error("‚ùå bookingList element not found");
                return;
            }
            bookingList.innerHTML = "";

            data.bookings.forEach(booking => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${booking.ticketId}</td>
                <td>${booking.name}</td>
                <td>${booking.temple}</td>
                <td>${booking.date}</td>
                <td>
                <select id="status-${booking.ticketId}" onchange="updateBookingStatus('${booking.ticketId}', this.value)">
                    <option value="Pending" ${booking.status === "Pending" ? "selected" : ""}>Pending</option>
                    <option value="Approved" ${booking.status === "Approved" ? "selected" : ""}>Approved</option>
                    <option value="Cancelled" ${booking.status === "Cancelled" ? "selected" : ""}>Cancelled</option>
                </select>
                </td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteBooking('${booking.ticketId}')">Delete</button></td>`;
            bookingList.appendChild(row);
            });
        } catch (err) {
            console.error("\u274C Error fetching bookings:", err);
        }
        }

        // ‚úÖ Update Booking Status
        async function updateBookingStatus(ticketId, newStatus) {
        try {
            const res = await fetch(`${AppConfig.API_BASE_URL}/api/updateBooking`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticketId, status: newStatus })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert("Booking updated successfully!");
            fetchBookings();
            fetchDashboardStats();
        } catch (err) {
            console.error("\u274C Booking update failed:", err);
            alert("Failed to update booking.");
        }
        }

        // ‚úÖ Delete Booking
        async function deleteBooking(ticketId) {
        if (!confirm("Are you sure you want to delete this booking?")) return;
        try {
            const res = await fetch(`${AppConfig.API_BASE_URL}/api/deleteBooking?ticketId=${ticketId}`, { method: "DELETE" });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert("Booking deleted.");
            fetchBookings();
        } catch (err) {
            console.error("\u274C Delete booking failed:", err);
        }
        }

        // ‚úÖ Clear All Bookings
        async function clearAllBookings() {
        if (!confirm("Delete ALL bookings?")) return;
        try {
            const res = await fetch(`${AppConfig.API_BASE_URL}/api/clearBookings`, { method: "DELETE" });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert("All bookings deleted.");
            fetchBookings();
        } catch (err) {
            console.error("\u274C Clear all bookings failed:", err);
        }
        }

        // ‚úÖ Filter Bookings Locally
        function filterBookings() {
        const search = document.getElementById("searchBooking").value.toLowerCase();
        document.querySelectorAll("#bookingList tr").forEach(row => {
            const values = Array.from(row.children).map(cell => cell.innerText.toLowerCase());
            row.style.display = values.some(text => text.includes(search)) ? "" : "none";
        });
        }

        // ‚úÖ Track Ticket Function
        async function trackTicket() {
            const ticketId = document.getElementById("trackTicketId").value.trim();
            const ticketDetails = document.getElementById("ticketDetails");
            
            if (!ticketId) {
                ticketDetails.innerHTML = "<div class='alert alert-warning'>Please enter a Ticket ID.</div>";
                return;
            }
            
            console.log("üîç Tracking ticket with ID:", ticketId);
            console.log("üåê API_BASE_URL:", AppConfig?.API_BASE_URL || "NOT LOADED!");
            
            ticketDetails.innerHTML = "<div class='text-center'><div class='spinner-border text-primary'></div><p>Searching...</p></div>";
            
            try {
                const apiUrl = `${AppConfig.API_BASE_URL}/api/getBooking?ticketId=${ticketId}`;
                console.log("üì° Fetching from:", apiUrl);
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log("üì¶ Response:", data);
                
                if (!data.success || !data.booking) {
                    ticketDetails.innerHTML = "<div class='alert alert-danger'>‚ùå Booking not found. Please check the Ticket ID.</div>";
                    return;
                }
                
                const booking = data.booking;
                ticketDetails.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-ticket-alt"></i> Booking Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Ticket ID:</strong> ${booking.ticketId}</p>
                                    <p><strong>Name:</strong> ${booking.name}</p>
                                    <p><strong>Mobile:</strong> ${booking.mobile}</p>
                                    <p><strong>Email:</strong> ${booking.email}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Temple:</strong> ${booking.temple}</p>
                                    <p><strong>Date:</strong> ${booking.date}</p>
                                    <p><strong>Time:</strong> ${booking.time}</p>
                                    <p><strong>Status:</strong> <span class="badge bg-${booking.status === 'Approved' ? 'success' : booking.status === 'Pending' ? 'warning' : 'danger'}">${booking.status}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("Error tracking ticket:", error);
                ticketDetails.innerHTML = "<div class='alert alert-danger'>‚ùå Error occurred while tracking ticket.</div>";
            }
        }

        // ‚úÖ Go Home
        function goHome() {
            window.location.href = "index.html";
        }

        // ‚úÖ Logout
        function handleAdminLogout() {
        if (confirm("Are you sure you want to logout?")) {
            localStorage.removeItem("adminUser");
            alert("Admin logged out.");
            window.location.href = "index.html";
        }
        }

        // ‚úÖ Notification Broadcast
        let isBroadcast = false;
        function toggleBroadcastMode() {
        isBroadcast = document.getElementById("broadcastToggle").checked;
        document.getElementById("userEmailField").style.display = isBroadcast ? "none" : "block";
        }

        // ‚úÖ Send Notification
        async function sendNotification() {
        const message = document.getElementById("notifyMessage").value.trim();
        const type = document.getElementById("notifyType").value;
        const email = document.getElementById("notifyEmail")?.value.trim();

        if (!message || !type || (!isBroadcast && !email)) return alert("Fill all required fields.");

        try {
            const payload = isBroadcast ? { message, type, broadcast: true } : { message, type, userEmail: email };
            const res = await fetch(`${AppConfig.API_BASE_URL}/api/notifications/send`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert("Notification sent.");
            document.getElementById("notifyMessage").value = "";
            if (!isBroadcast) document.getElementById("notifyEmail").value = "";
        } catch (err) {
            console.error("\u274C Notification send error:", err);
            alert("Failed to send notification.");
        }
        }

        // ‚úÖ Export Options
        function exportBookings(format) {
        const status = document.getElementById("filterStatus").value;
        const start = document.getElementById("filterStartDate").value;
        const end = document.getElementById("filterEndDate").value;

        fetch(`${AppConfig.API_BASE_URL}/api/bookings?status=${status}&startDate=${start}&endDate=${end}`)
            .then(res => res.json())
            .then(data => {
            if (!data.success) return alert("Failed to fetch bookings!");
            if (format === "csv") exportAsCSV(data.bookings);
            else if (format === "excel") exportAsExcel(data.bookings);
            else if (format === "pdf") exportAsPDF(data.bookings);
            })
            .catch(err => alert("Failed to export: " + err));
        }

        function exportAsCSV(bookings) {
        let csv = "Ticket ID,Name,Mobile,Email,Temple,Date,Time,Status\n";
        bookings.forEach(b => {
            csv += `${b.ticketId},${b.name},${b.mobile},${b.email},${b.temple},${b.date},${b.time},${b.status}\n`;
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
        link.download = "bookings_report.csv";
        link.click();
        }

        function exportAsExcel(bookings) {
        let csv = "Ticket ID,Name,Mobile,Email,Temple,Date,Time,Status\n";
        bookings.forEach(b => {
            csv += `${b.ticketId},${b.name},${b.mobile},${b.email},${b.temple},${b.date},${b.time},${b.status}\n`;
        });
        const blob = new Blob([csv], { type: "application/vnd.ms-excel" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "bookings_report.xlsx";
        link.click();
        }

        async function exportAsPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Pilgrimage Booking Report", 10, 10);
            const res = await fetch(`${AppConfig.API_BASE_URL}/api/bookings`);
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            let y = 20;
            data.bookings.forEach((b, i) => {
            doc.text(`${i + 1}. ${b.name} - ${b.temple} - ${b.date} - ${b.status}`, 10, y);
            y += 10;
            });
            doc.save("Booking_Report.pdf");
        } catch (err) {
            console.error("\u274C PDF export error:", err);
        }
        }

    </script>
</body>
</html>